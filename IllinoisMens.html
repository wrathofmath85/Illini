<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>College Hoops — Weekly Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts & minimal styling -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020; --card:#111735; --muted:#7e86a6; --text:#eaf0ff;
      --chip:#19214a; --border:#222b5a; --hdr:#0d1330;
      --good:#34d399; --warn:#fbbf24;

      /* Illinois brand */
      --illini-orange:#E84A27;
      --illini-blue:#13294B;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%, #0c163a 100%); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1300px; margin:28px auto; padding:0 16px;}
    h1{font-size:28px;margin:0 0 6px 0;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted); margin-bottom:18px}

    /* Section cards */
    .section{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; margin-bottom:16px}
    .section h2{margin:0 0 4px 0; font-size:20px; font-weight:800}
    .meta{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px; margin-bottom:10px}

    /* Week table */
    .weekboard{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    .weekboard thead th{background:var(--hdr); color:#cfe2ff; font-weight:700; font-size:12px; padding:10px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap}
    .weekboard tbody td, .weekboard tbody th{padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:top; font-size:13px}
    .teamCol{white-space:nowrap}
    .rankchips{display:flex; gap:6px; flex-wrap:wrap; margin-top:4px}
    .chip{display:inline-block; background:var(--chip); border:1px solid #2a3472; color:#dbe5ff; padding:2px 8px; border-radius:999px; font-size:11px}
    .chip.good{border-color:#1f5e44; background:rgba(52,211,153,.12); color:#c9ffe8}
    .chip.warn{border-color:#6b4b12; background:rgba(251,191,36,.12); color:#ffe9b8}

    .apmeta{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
    .apmeta .chip{border-color:#39418d}

    .game{display:flex; flex-direction:column; gap:2px; margin-bottom:6px}
    .line{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .pill{padding:1px 6px; border-radius:6px; font-weight:700; font-size:10px; border:1px solid #2b356d; background:#0e1540}
    .final{color:#c4ffd8; border-color:#2a5e48; background:#0f2b24}
    .live{color:#ffedd5; border-color:#7a4e0d; background:#2a1a05}
    .muted{color:var(--muted)}
    .tiny{font-size:11px}
    .nowrap{white-space:nowrap}
    .tv{word-break:keep-all}

    /* Sticky team column on wide screens */
    @media (min-width: 900px){
      .weekboard thead th.sticky, .weekboard tbody th.sticky{
        position:sticky; left:0; z-index:2; background:linear-gradient(90deg, var(--hdr) 0%, var(--hdr) 70%, rgba(13,19,48,0) 100%);
      }
      .weekboard tbody th.sticky{background:linear-gradient(90deg, var(--card) 0%, var(--card) 70%, rgba(17,23,53,0) 100%); z-index:1}
      .scroller{overflow-x:auto}
    }

    .badge{font-size:11px; padding:2px 6px; border-radius:999px; background:#0d1330; border:1px solid #28306a; color:#cfe2ff}

    /* Illinois highlight */
    .illini{
      background:var(--illini-orange);
      color:var(--illini-blue);
      padding:0 6px;
      border-radius:6px;
      font-weight:800;
    }

    /* --------- MOBILE-ONLY ENHANCEMENTS (≤ 720px) --------- */
    .only-mobile{display:none}

    @media (max-width:720px){
      .wrap{padding:0 10px; margin:22px auto}
      h1{font-size:24px}
      .section{padding:10px; border-radius:14px}
      .section h2{font-size:18px}
      .meta{font-size:11px}

      .weekboard thead th{font-size:11px; padding:8px 8px}
      .weekboard tbody td, .weekboard tbody th{font-size:12px; padding:8px}
      .game{gap:1px; margin-bottom:8px}
      .pill{font-size:9px}
      .tiny{font-size:10px}

      /* Give each day column a sensible width for smooth horizontal scroll */
      #apTable tbody td, #oocTable tbody td, #b1gTable tbody td{min-width:160px}

      /* Hide spacer column after team on AP & OOC */
      #apTable thead th:nth-child(2),
      #apTable tbody td:nth-child(2),
      #oocTable thead th:nth-child(2),
      #oocTable tbody td:nth-child(2){
        display:none;
      }

      /* In Big Ten, hide Overall, Conf and AP/KP columns to free space */
      #b1gTable thead th:nth-child(2),
      #b1gTable tbody td:nth-child(2),
      #b1gTable thead th:nth-child(3),
      #b1gTable tbody td:nth-child(3),
      #b1gTable thead th:nth-child(4),
      #b1gTable tbody td:nth-child(4){
        display:none;
      }

      /* Show mobile-only chips under team name in Big Ten rows */
      .only-mobile{display:block; margin-top:6px}

      /* Make long network strings wrap more gracefully */
      .tv{white-space:normal; word-break:break-word}
    }
  </style>

  <!-- PapaParse & Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script>dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_timezone);</script>
</head>
<body>
  <div class="wrap">
    <h1>College Hoops — Weekly Board</h1>
    <div class="sub" id="weekLabel">Loading week…</div>

    <!-- AP Top N -->
    <section class="section">
      <h2 id="apHeader">AP Top — Weekly Slate</h2>
      <div class="meta">
        <span class="badge" id="apCount">0 teams</span>
        <span class="muted tiny">AP / Coaches / KenPom + AP Points & First-place votes</span>
      </div>
      <div class="scroller">
        <table class="weekboard" id="apTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Illinois OOC -->
    <section class="section">
      <h2>Illinois OOC Opponents — Weekly Slate</h2>
      <div class="meta">
        <span class="badge" id="oocCount">0 opponents</span>
        <span class="muted tiny">Opponents list from your spec</span>
      </div>
      <div class="scroller">
        <table class="weekboard" id="oocTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Big Ten -->
    <section class="section">
      <h2>Big Ten — Standings & Weekly Slate</h2>
      <div class="meta">
        <span class="badge" id="b1gCount">0 teams</span>
        <span class="muted tiny">Sorted by OverallPct (then wins)</span>
      </div>
      <div class="scroller">
        <table class="weekboard" id="b1gTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="muted tiny" style="margin-top:8px">
      Sources: AP & Coaches Top 25, Team Schedules, Standings, KenPom (Team2 used as the canonical match). Times shown in ET.
    </div>
  </div>

  <script>
  // ========= CONFIG =========
  // 1) Set your week here (any Monday in ET):
  const WEEK_START = "2025-11-03"; // <-- change this; must be a Monday (ET)
  const TZ = "America/New_York";

  // 2) Data sources
  const URLS = {
    ap: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSkcLAiNAH3ccrZEFjr8ONOP1ktnnVczk8IqZ1sZ65HcxxRwAQUD75cKz9eh4h7WiV6puPycS0o56FL/pub?gid=373873164&single=true&output=csv",
    coaches: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSkcLAiNAH3ccrZEFjr8ONOP1ktnnVczk8IqZ1sZ65HcxxRwAQUD75cKz9eh4h7WiV6puPycS0o56FL/pub?gid=477166523&single=true&output=csv",
    schedule: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsbB8QIfHsfefXzCc-eEDAw0T9Z2MPsAfnOp6BN33ZkPJBQ97RdHw7qs-v3MuGQaxfWUWmOCQtv2Mm/pub?gid=830783021&single=true&output=csv",
    standings: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSuYr6k69OmX2LyxR_69Xhd_10nYOmH9W_rNDcfwefavlRbpdLV4GnD_lB0cZtAFexA_tRUki8FTnV/pub?gid=335851738&single=true&output=csv",
    kenpom: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpEizCaqirmqDs-G7DoI70aab-WxepYTQz1myBK79BPZQaznnx4PYW3AeTkm7lWPRUv8uLParc8PpZ/pub?gid=917670909&single=true&output=csv"
  };

  // 3) Illinois OOC list
  const ILLINOIS_OOC = [
    "Jackson State Tigers","Florida Gulf Coast Eagles","Texas Tech Red Raiders","Colgate Raiders","Alabama Crimson Tide",
    "Long Island University Sharks","UT Rio Grande Valley Vaqueros","UConn Huskies","Tennessee Volunteers","Missouri Tigers","Southern Jaguars"
  ];

  // 4) Name normalization + aliases
  const ALIASES = new Map([
    ["uconn","connecticut"],
    ["ut-rio grande valley","texas rio grande valley"],
    ["liubrooklyn","liu brooklyn"],
    ["st johns","st. john's"],
    ["saint johns","st. john's"],
    ["jackson st","jackson state"]
  ]);
  function normalizeName(s){
    if(!s) return "";
    let t = String(s).trim().toLowerCase();
    t = t.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035']/g,"");
    t = t.replace(/\./g,"");
    t = t.replace(/&/g,"and");
    t = t.replace(/\s+/g," ");
    t = t.replace(/\bsaint\b/g,"st");
    t = t.replace(/-+/g," ");
    t = t.trim();
    const alias = ALIASES.get(t.replace(/\s/g,""));
    return alias ? alias : t;
  }

  // ===== Utilities =====
  function safeInt(x){ const n = parseInt(x,10); return Number.isFinite(n) ? n : null; }

  function fetchCSV(url){
    return new Promise((resolve,reject)=>{
      Papa.parse(url, {
        download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
        complete: (res)=> resolve(res.data),
        error: (err)=> reject(err)
      });
    });
  }

  function mondayOf(dateStr){
    const d = dayjs.tz(dateStr, TZ).startOf('day');
    const dow = d.day(); // 0=Sun
    const off = (dow===0) ? -6 : (1 - dow);
    return d.add(off,'day');
  }
  function sundayOf(mon){ return mon.add(6,'day').endOf('day'); }

  function weekDays(mon){
    return Array.from({length:7}, (_,i)=> mon.add(i,'day'));
  }

  function formatDayHead(d){ return d.format("ddd M/D"); }
  function formatTimeET(startET){
    if(!startET) return "";
    const d = dayjs.tz(startET, TZ);
    return d.isValid() ? d.format("h:mm A") : String(startET);
  }

  function statusPill(status){
    if(!status) return "";
    const s = String(status).toLowerCase();
    if(s.includes("final")) return `<span class="pill final">FINAL</span>`;
    if(s.includes("live")) return `<span class="pill live">LIVE</span>`;
    return `<span class="pill">${status}</span>`;
  }

  // ---- TV extraction: robustly coalesce across common headers
  function extractTVFromRow(r){
    const candidates = [
      r.TV, r.Tv, r.tv, r.Network, r.Television, r.Broadcast, r.Channel,
      r["Time/TV"], r["Time / TV"], r.TimeTV, r["Time Tv"], r["Time tv"]
    ];
    let tv = (candidates.find(v => v && String(v).trim()) || "").toString().trim();

    // If the sheet separates streaming, include that too
    const streaming = (r.Streaming || r["Streams"] || r["Stream"] || "").toString().trim();

    // Clean stray em dashes / placeholders
    const clean = s => s.replace(/^—+$/,"").replace(/^\s*-\s*$/,"").trim();

    tv = clean(tv);
    const streamClean = clean(streaming);

    if(tv && streamClean){
      return `${tv}, ${streamClean}`;
    }else if(streamClean){
      return streamClean;
    }else{
      return tv; // may be empty string
    }
  }

  function buildScheduleIndex(rows){
    const byTeam = new Map();
    function push(name, game){
      const k = normalizeName(name);
      if(!k) return;
      if(!byTeam.has(k)) byTeam.set(k, []);
      byTeam.get(k).push(game);
    }
    rows.forEach(r=>{
      const g = {
        id: r.GameId,
        start: r.StartET,
        status: r.Status,
        home: r.Home, away: r.Away,
        homeScore: r.HomeScore, awayScore: r.AwayScore,
        tv: extractTVFromRow(r),
        venue: r.Venue, city: r.City, state: r.State
      };
      push(r.Home, {...g, isHome:true, opp:r.Away});
      push(r.Away, {...g, isHome:false, opp:r.Home});
    });
    return byTeam;
  }

  function gamesOnDayFor(team, day, schedIndex){
    const k = normalizeName(team);
    const start = day.startOf('day');
    const end = day.endOf('day');
    const arr = schedIndex.get(k) || [];
    return arr.filter(g=>{
      const t = dayjs.tz(g.start, TZ);
      return t.isAfter(start.subtract(1,'ms')) && t.isBefore(end.add(1,'ms'));
    }).sort((a,b)=> dayjs.tz(a.start,TZ)-dayjs.tz(b.start,TZ));
  }

  function indexRanks(rows, keyField="Team", valueField="Rank"){
    const m = new Map();
    rows.forEach(r=>{
      const k = normalizeName(r[keyField]);
      const v = safeInt(r[valueField]);
      if(k && v != null) m.set(k, v);
    });
    return m;
  }

  function buildKenPomMap(rows){
    const m = new Map(); // key: Team2 normalized -> rank
    rows.forEach(r=>{
      const k = normalizeName(r.Team2 || r.Team || "");
      const v = safeInt(r.Rank);
      if(k && v != null) m.set(k, v);
    });
    return m;
  }

  function rankChips(teamName, apMap, ccMap, kpMap){
    const k = normalizeName(teamName);
    const ap = apMap.get(k) ?? null;
    const cc = ccMap.get(k) ?? null;
    const kp = kpMap.get(k) ?? null;
    return `
      <div class="rankchips">
        <span class="chip">${ap?`AP #${ap}`:"AP —"}</span>
        <span class="chip">${cc?`Coaches #${cc}`:"Coaches —"}</span>
        <span class="chip ${kp && kp<=25?'good':''}">${kp?`KP #${kp}`:"KP —"}</span>
      </div>
    `;
  }

  // AP points + first place votes chips (AP section only)
  function apMetaChips(points, firstVotes){
    const pts = points ? `<span class="chip">Pts ${points}</span>` : "";
    const fp = firstVotes ? `<span class="chip">1st ${firstVotes}</span>` : "";
    return `<div class="apmeta">${pts}${fp}</div>`;
  }

  // Compact inline ranks for opponent display
  function rankInline(teamName, apMap, ccMap, kpMap){
    const k = normalizeName(teamName);
    const ap = apMap.get(k); const cc = ccMap.get(k); const kp = kpMap.get(k);
    const parts = [];
    if (ap != null) parts.push(`AP #${ap}`);
    if (cc != null) parts.push(`C #${cc}`);
    if (kp != null) parts.push(`KP #${kp}`);
    return parts.length ? ` <span class="tiny muted">(${parts.join(" • ")})</span>` : "";
  }

  // Illinois highlight helpers
  function isIllini(name){
    const raw = (name||"").toLowerCase();
    const norm = normalizeName(name);
    return raw.includes("illinois fighting illini") || norm === "illinois";
  }
  function hlIllini(name){
    return isIllini(name) ? `<span class="illini">${name}</span>` : name;
  }

  function renderDayCell(team, day, schedIndex, apMap, ccMap, kpMap){
    const games = gamesOnDayFor(team, day, schedIndex);
    if(!games.length) return `<div class="muted tiny">—</div>`;
    return games.map(g=>{
      const tvPiece = g.tv ? ` <span class="tv">• ${g.tv}</span>` : "";
      const score = (g.homeScore || g.awayScore) ? ` (${g.awayScore}–${g.homeScore})` : "";
      const atvs = g.isHome ? "vs" : "@";
      const oppName = hlIllini(g.opp);
      const oppRanks = rankInline(g.opp, apMap, ccMap, kpMap);
      return `
        <div class="game">
          <div class="line">
            ${statusPill(g.status)}
            <span class="nowrap tiny">${formatTimeET(g.start)}</span>
          </div>
          <div class="tiny">${atvs} <strong>${oppName}</strong>${oppRanks}${score}${tvPiece}</div>
          <div class="tiny muted">— ${g.city || ""}${g.state?`, ${g.state}`:""}</div>
        </div>
      `;
    }).join("");
  }

  function renderWeekHeader(tableEl, days, showRecordCols=false){
    const thead = tableEl.querySelector("thead");
    const dayHeads = days.map(d=> `<th>${formatDayHead(d)}</th>`).join("");
    thead.innerHTML = `
      <tr>
        <th class="sticky teamCol">Team</th>
        ${showRecordCols ? `<th>Overall</th><th>Conf</th><th>AP / Coaches / KP</th>` : `<th>AP / Coaches / KP</th>`}
        ${dayHeads}
      </tr>
    `;
  }

  function parseWL(s){ const m = String(s||"").match(/(\d+)\D+(\d+)/); return m ? {w:+m[1], l:+m[2]} : {w:0,l:0}; }

  (async function(){
    const mon = mondayOf(WEEK_START);
    const sun = sundayOf(mon);
    const days = weekDays(mon);
    document.getElementById("weekLabel").textContent = `Week of ${mon.format("dddd, MMM D, YYYY")} – ${sun.format("dddd, MMM D, YYYY")} (ET)`;

    try{
      // Load all data
      const [kenpom, ap, coaches, standings, schedule] = await Promise.all([
        fetchCSV(URLS.kenpom),
        fetchCSV(URLS.ap),
        fetchCSV(URLS.coaches),
        fetchCSV(URLS.standings),
        fetchCSV(URLS.schedule)
      ]);

      // Indexes / maps
      const kpMap = buildKenPomMap(kenpom);
      const apMap = indexRanks(ap, "Team", "Rank");
      const ccMap = indexRanks(coaches, "Team", "Rank");
      const schedIndex = buildScheduleIndex(schedule);

      // ===== AP Top N =====
      const apTop = ap.filter(r=> safeInt(r.Rank));
      const apN = apTop.length;
      document.getElementById("apHeader").textContent = `AP Top ${apN} — Weekly Slate`;
      document.getElementById("apCount").textContent = `${apN} teams`;

      const apTable = document.getElementById("apTable");
      renderWeekHeader(apTable, days, /*showRecordCols*/ false);

      const apTbody = apTable.querySelector("tbody");
      apTbody.innerHTML = apTop.map(r=>{
        const team = r.Team;
        const teamDisplay = hlIllini(team);
        const chips = rankChips(team, apMap, ccMap, kpMap);
        const apMeta = apMetaChips(r.Points, r.FirstPlaceVotes);
        const dayCells = days.map(d=> `<td>${renderDayCell(team, d, schedIndex, apMap, ccMap, kpMap)}</td>`).join("");
        return `
          <tr>
            <th class="sticky teamCol">
              <div><strong>${r.Rank ? `#${r.Rank} `:""}${teamDisplay}</strong>${chips}${apMeta}</div>
            </th>
            <td></td>
            ${dayCells}
          </tr>
        `;
      }).join("");

      // ===== Illinois OOC =====
      document.getElementById("oocCount").textContent = `${ILLINOIS_OOC.length} opponents`;
      const oocTable = document.getElementById("oocTable");
      renderWeekHeader(oocTable, days, /*showRecordCols*/ false);
      const oocTbody = oocTable.querySelector("tbody");
      oocTbody.innerHTML = ILLINOIS_OOC.map(name=>{
        const nameDisplay = hlIllini(name);
        const chips = rankChips(name, apMap, ccMap, kpMap);
        const dayCells = days.map(d=> `<td>${renderDayCell(name, d, schedIndex, apMap, ccMap, kpMap)}</td>`).join("");
        return `
          <tr>
            <th class="sticky teamCol"><div><strong>${nameDisplay}</strong>${chips}</div></th>
            <td></td>
            ${dayCells}
          </tr>
        `;
      }).join("");

      // ===== Big Ten =====
      const bigTenRows = standings.filter(r=>{
        const c = String(r.Conference||"").toLowerCase();
        return c.includes("big ten") || c === "b10" || c.includes("big-ten");
      });

      bigTenRows.sort((a,b)=>{
        const apct = parseFloat(a.OverallPct||"0") || 0;
        const bpct = parseFloat(b.OverallPct||"0") || 0;
        if(bpct!==apct) return bpct - apct;
        return parseWL(b.Overall).w - parseWL(a.Overall).w;
      });

      document.getElementById("b1gCount").textContent = `${bigTenRows.length} teams`;

      const b1gTable = document.getElementById("b1gTable");
      renderWeekHeader(b1gTable, days, /*showRecordCols*/ true);
      const b1gBody = b1gTable.querySelector("tbody");
      b1gBody.innerHTML = bigTenRows.map(r=>{
        const team = r.Team;
        const teamDisplay = hlIllini(team);
        const chipsCell = `${rankChips(team, apMap, ccMap, kpMap)}`;
        const dayCells = days.map(d=> `<td>${renderDayCell(team, d, schedIndex, apMap, ccMap, kpMap)}</td>`).join("");
        const overallPct = (parseFloat(r.OverallPct)||0).toFixed(3);
        const confPct = (parseFloat(r.ConfPct)||0).toFixed(3);
        return `
          <tr>
            <th class="sticky teamCol">
              <strong>${teamDisplay}</strong>
              <div class="only-mobile">${chipsCell}</div>
            </th>
            <td>${r.Overall || "—"} <span class="muted tiny">(${overallPct})</span></td>
            <td>${r.ConfWL || "—"} <span class="muted tiny">(${confPct})</span></td>
            <td>${chipsCell}</td>
            ${dayCells}
          </tr>
        `;
      }).join("");

    }catch(err){
      console.error(err);
      document.getElementById("weekLabel").textContent = "Error loading one or more CSVs. See console.";
      alert("Error loading one or more CSVs. Open the browser console for details.");
    }
  })();
  </script>
</body>
</html>
